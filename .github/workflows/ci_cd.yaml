name: Pipeline

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ '*' ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install dependencies
      run: make install

    - name: Configure and Build
      run: make all

    - name: Run tests
      run: make test  

    - name: Generate coverage report
      run: make coverage

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-details 
        path: build/coverage_report/coverage_details.html # Contains the coverage of all files

    - name: Extract Coverage Percentage
      run: |
        if [ ! -f "build/coverage_report/coverage.csv" ]; then
            echo "CSV file does not exist."
            exit 1
        else
            echo "CSV file exists"
        fi

        total_lines=0
        total_covered=0

        skip_headers=1
        while IFS=, read -r filename line_total line_covered line_percent
        do
            if ((skip_headers))
            then
                ((skip_headers--))
            else
                echo "I got:$line_total|$line_covered|$line_percent"
                total_lines=$((total_lines + line_total))
                total_covered=$((total_covered + line_covered))
            fi
        done < build/coverage_report/coverage.csv

        echo "Total lines: $total_lines"
        echo "Total covered: $total_covered"

        if ((total_lines > 0)); then
            overall_coverage=$(echo "scale=2; $total_covered / $total_lines * 100" | bc)
            echo "Overall line coverage: $overall_coverage%"
        else
            echo "No total lines to calculate coverage."
        fi
