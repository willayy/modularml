name: Pipeline

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ '*' ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install dependencies
      run: make install

    - name: Configure and Build
      run: make all

    - name: Run tests
      run: make test  

    - name: Generate coverage report
      run: make coverage

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-details 
        path: build/coverage_report/coverage_details.html # Contains the coverage of all files

    - name: Extract Coverage Percentage
      run: |
        if [ ! -f "build/coverage_report/coverage.csv" ]; then
          echo "CSV file does not exist."
          exit 1
        fi

        total_lines=0
        total_covered=0

        # Read the CSV file line by line (skip the header)
        tail -n +2 "build/coverage_report/coverage.csv" | while IFS=',' read -r filename line_total line_covered line_percent branch_total branch_covered branch_percent function_total function_covered function_percent; do
            # Accumulate total lines and covered lines
            total_lines=$(echo "$total_lines + $line_total" | bc)
            total_covered=$(echo "$total_covered + $line_covered" | bc)
        done

        # Calculate the overall line coverage percentage
        if [ "$total_lines" -gt 0 ]; then
            line_coverage_percent=$(echo "scale=2; $total_covered / $total_lines * 100" | bc)
            echo "Overall Line Coverage: $line_coverage_percent%"
        else
            echo "No lines to calculate coverage."
        fi
